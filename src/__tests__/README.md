# Тесты tg2md

## Запуск

```bash
npx vitest run        # один раз
npx vitest            # watch-режим
```

## Структура

Тесты:
```
__tests__/
├── helpers.ts                 # Общие хелперы (makeMsg, entity)
├── fixtures/
│   ├── minimal-export.json    # Минимальный Telegram-экспорт (2 сообщения)
│   └── mixed-messages.json    # Экспорт с фильтруемыми сообщениями
├── slugify.test.ts            # Транслитерация и генерация slug
├── formatting.test.ts         # Конвертация entity → Markdown
├── extractors.test.ts         # Извлечение заголовка и описания
├── converter.test.ts          # Сборка итогового Markdown
├── parser.test.ts             # Парсинг и фильтрация JSON-экспорта
└── cli.integration.test.ts    # E2E: CLI, parseArgs, uniqueFilename, флаги
```

## Что тестируется и зачем

### `slugify.test.ts` — Транслитерация и slug

Модуль `slugify` преобразует заголовки (в том числе кириллические) в URL-safe slugs для имён файлов.

| Сценарий | Зачем |
|----------|-------|
| Кириллический текст → латиница | Основная функция: `Привет мир` → `privet-mir` |
| Латиница в нижний регистр | `Hello World` → `hello-world` |
| Удаление спецсимволов | `TypeScript: type vs interface!` → без `:` и `!` |
| Буква `ё` | Частая ошибка транслитерации: `Ёжик` → `yozhik` |
| Обрезка до 80 символов | Защита от слишком длинных имён файлов |
| Пустая строка | Граничный случай — не должно падать |
| Только спецсимволы | `!!!???` → пустая строка |
| Смешанная кириллица и латиница | `React 18: что нового` — частый реальный кейс |
| Схлопывание дефисов | `hello   world` → `hello-world`, не `hello---world` |

---

### `formatting.test.ts` — Конвертация entity → Markdown

Модуль `formatting` содержит утилиты форматирования: конвертация Telegram-сущностей в Markdown, форматирование дат, escape YAML и т.д.

#### `convertEntities` — Telegram entity → Markdown

| Сценарий | Зачем |
|----------|-------|
| `plain` → текст как есть | Базовый кейс |
| `bold` → `**text**` | Markdown bold |
| `italic` → `*text*` | Markdown italic |
| `code` → `` `text` `` | Inline code |
| `pre` → блок кода | Fenced code block |
| `text_link` → `[text](url)` | Markdown ссылка |
| `spoiler` → `<span class="spoiler">` | Нет нативного Markdown для спойлеров |
| `blockquote` → `> line` | Каждая строка с префиксом `>` |
| `underline` → `<u>text</u>` | HTML для подчёркивания |
| `strikethrough` → `~~text~~` | Markdown strikethrough |
| `custom_emoji` → текст как есть | Fallback на стандартный emoji |
| `bot_command` → inline code | `/start` как код |
| `hashtag`, `mention` → текст как есть | Не требуют обёртки |
| Неизвестный тип → текст как есть | Forward-compatible |
| Пустой массив → `""` | Граничный случай |
| `skipFirstBold=true` | Первый bold идёт в заголовок frontmatter, не в тело |
| Комбинация разных типов | Интеграционный тест форматирования |

#### `formatAstroDate` — Дата для Astro frontmatter

| Сценарий | Зачем |
|----------|-------|
| Обычная дата | `2026-02-02T13:43:57` → `Feb 02 2026` |
| Конец года | `Dec 31` — граница месяцев |
| Начало года | `Jan 01` — граница годов |

#### `escapeYaml` — Экранирование YAML

| Сценарий | Зачем |
|----------|-------|
| Одинарная кавычка → удвоение | YAML: `'It''s'` |
| Строка без кавычек | Не должна меняться |
| Несколько кавычек | Все должны быть удвоены |

#### `getPhotoImagePath` — Путь к изображению

| Сценарий | Зачем |
|----------|-------|
| Путь с директорией | `photos/photo.jpg` → `/images/photo.jpg` |
| Просто имя файла | `photo.png` → `/images/photo.png` |

#### `truncateOnWordBoundary` — Обрезка текста

| Сценарий | Зачем |
|----------|-------|
| Короткий текст | Не обрезается |
| Длинный текст | Обрезка по границе слова с `...` |
| Пунктуация перед `...` | Убирается: не `word,...` а `word...` |

#### `extractFirstSentence` — Первое предложение

| Сценарий | Зачем |
|----------|-------|
| Точка | `Hello world. More.` → `Hello world.` |
| Вопросительный знак | `Really? Yes.` → `Really?` |
| Восклицательный знак | `Wow! Amazing.` → `Wow!` |
| Нет границы предложения | Возвращает весь текст |
| Пробелы | Trimming |

---

### `extractors.test.ts` — Извлечение заголовка и описания

Модуль `extractors` извлекает из сообщения заголовок и описание для Astro frontmatter.

#### `extractTitle`

| Сценарий | Зачем |
|----------|-------|
| Первый bold → заголовок | Основной кейс |
| Trim пробелов в bold | `  Spaced Title  ` → `Spaced Title` |
| Нет bold → первое предложение | Fallback |
| Пустые entities → `post-{id}` | Fallback последней инстанции |
| Bold из пробелов → `post-{id}` | Пустой bold — не заголовок |
| Длинное предложение → обрезка 100 символов | Защита имени файла |
| Пустые строки в начале | Пропускаются, берётся первая непустая |

#### `extractDescription`

| Сценарий | Зачем |
|----------|-------|
| Первый абзац после заголовка | Основной кейс |
| Обрезка длинного описания до 160 символов | SEO-ограничение |
| Нет текста кроме заголовка → используется заголовок | Fallback |
| Берёт только первый абзац | Не весь текст |
| Замена `\n` на пробелы | Описание — одна строка |

---

### `converter.test.ts` — Сборка итогового Markdown

Модуль `converter` собирает готовый Markdown-файл из сообщения: frontmatter + body.

#### `generateFilename`

| Сценарий | Зачем |
|----------|-------|
| Формат `YYYY-MM-DD-slug.md` | Основной формат имени файла |
| Кириллический заголовок → транслитерация | Интеграция с `slugify` |
| Дата из сообщения | Корректное извлечение даты |

#### `convertMessage`

| Сценарий | Зачем |
|----------|-------|
| Frontmatter с title, description, pubDate | Обязательные поля |
| `heroImage` при наличии фото | Условное поле |
| Нет `heroImage` без фото | Не добавляется лишнее |
| Bold-заголовок не дублируется в body | Заголовок только в frontmatter |
| Escape кавычек в frontmatter | YAML-безопасность |
| Файл заканчивается `\n` | POSIX-совместимость |

---

### `parser.test.ts` — Парсинг JSON-экспорта

Модуль `parser` читает `result.json` и фильтрует сообщения.

#### Минимальный экспорт (`minimal-export.json`)

| Сценарий | Зачем |
|----------|-------|
| Извлечение имени канала | Корректный парсинг JSON |
| Все обычные сообщения | Не теряются при обработке |
| Сохранение id сообщений | Идентификация |
| Сохранение пути к фото | Для копирования изображений |
| Корректный `sourceDir` | Для резолва относительных путей |

#### Смешанные сообщения (`mixed-messages.json`)

| Сценарий | Зачем |
|----------|-------|
| Фильтрация пересланных | Репосты не конвертируются |
| Фильтрация сервисных | `type: "service"` не содержат контента |
| Фильтрация видео без текста | Только видео — пропускаем |
| Видео с текстом сохраняются | Текст важнее типа медиа |
| Обычные сообщения сохраняются | Не фильтруются по ошибке |
| Итого 2 сообщения | Проверка полноты фильтрации |

---

### `cli.integration.test.ts` — E2E-тесты CLI

Интеграционные тесты запускают скомпилированный CLI (`dist/index.js`) как отдельный процесс.

#### `parseArgs` — Парсинг аргументов

| Сценарий | Зачем |
|----------|-------|
| Просто путь к файлу | Базовый вызов |
| `--output` / `-o` | Кастомная директория |
| `--clean` / `-c` | Флаг очистки |
| `--rewrite` / `-r` | Флаг перезаписи |
| Комбинация флагов | Всё вместе работает |
| Путь после флагов | Порядок не важен |
| Без аргументов | Пустой `inputPath` |

#### `uniqueFilename` — Дедупликация имён

| Сценарий | Зачем |
|----------|-------|
| Уникальное имя — без изменений | Нет конфликта |
| Дубликат → добавление id | Два поста в один день с одинаковым заголовком |
| Сохранение расширения | `.md` всегда в конце |

#### CLI (E2E)

| Сценарий | Зачем |
|----------|-------|
| `--help` | Вывод справки |
| Без аргументов | Тоже справка |
| Несуществующий файл | Exit code 1 |
| Неизвестный флаг | Exit code 1 |
| Конвертация fixture | Создание `.md` файлов с frontmatter |
| Повторный запуск — skip | Не перезаписывает без `--rewrite` |
| `--rewrite` | Перезаписывает файлы |
| `--clean` | Удаляет лишние файлы |
| Создание `images/` | Директория для изображений |
